<!DOCTYPE html>
<html>
<head>
    <title>Simulator</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }

        #keyGuide {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #333;
        }

        #cameraViewport {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 200px; /* Adjust the width as needed */
            height: 150px; /* Adjust the height as needed */
            border: 1px solid #333;
            background-color: black;
        }
    </style>
</head>
<body>
<!-- Controls Guide -->
<div id="keyGuide">
    <strong>Controls:</strong><br>
    Base - Q/E<br>
    Upper Arm - W/S<br>
    Forearm - R/F<br>
</div>

<!-- Camera Viewport -->
<div id="cameraViewport"></div>

<!-- Three.js and OrbitControls Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<!-- Main Script for Robot Arm Simulation -->
<script>
    // Constants and Configuration
    const ARM_COLORS = {
        base: 0xff0000,
        shoulder: 0x00ff00,
        upperArm: 0x00ff00,
        forearm: 0x0000ff
    };

    // Scene Objects
    let scene, camera, renderer, controls;
    let base, shoulder, upperArm, elbow, forearm;
    let cameraViewportRenderer, cameraView;

    // Initialize Scene, Camera, and Renderer
    function init() {
        setupScene();
        setupCamera();
        setupRenderer();
        addLighting();
        addRobotArm();
        addFloor();
        setupControls();
        setupCameraViewport();
        animate();
    }

    // Setup the Three.js Scene
    function setupScene() {
        scene = new THREE.Scene();
    }

    // Setup the Camera
    function setupCamera() {
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(2, 1, 2);
    }

    // Setup the Renderer
    function setupRenderer() {
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
    }

    // Add Lighting to the Scene
    function addLighting() {
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0, 1, 1).normalize();
        scene.add(light);
    }

    // Add Robot Arm Components to the Scene
    function addRobotArm() {
        base = createSegment(0.5, 0.6, 0.3, ARM_COLORS.base, 0.15);
        shoulder = createSegment(0.25, 0.25, 0.4, ARM_COLORS.shoulder, 0.4);
        upperArm = createSegment(0.15, 0.15, 1.2, ARM_COLORS.upperArm, 0.6);

        // Create the green elbow joint sphere
        const elbowGeometry = new THREE.SphereGeometry(0.15, 32, 32);
        const elbowMaterial = new THREE.MeshStandardMaterial({color: 0x00ff00});
        elbow = new THREE.Mesh(elbowGeometry, elbowMaterial);
        elbow.position.y = 0.6; // Adjust the position as needed

        forearm = createSegment(0.1, 0.1, 1.0, ARM_COLORS.forearm, 0.5);

        scene.add(base);
        base.add(shoulder);
        shoulder.add(upperArm);
        upperArm.add(elbow); // Add the elbow joint to the upper arm
        elbow.add(forearm);
    }

    // Create a Segment of the Robot Arm
    function createSegment(topRadius, bottomRadius, height, color, yPos) {
        const geometry = new THREE.CylinderGeometry(topRadius, bottomRadius, height, 32);
        const material = new THREE.MeshStandardMaterial({color});
        const segment = new THREE.Mesh(geometry, material);
        segment.position.y = yPos;
        return segment;
    }

    // Add Floor to the Scene with Grey Background and Black Grid Pattern
    function addFloor() {
        // Create a grey background plane
        const backgroundGeometry = new THREE.PlaneGeometry(10, 10);
        const backgroundMaterial = new THREE.MeshStandardMaterial({
            color: 0xffffff,
            side: THREE.DoubleSide,
        });
        const background = new THREE.Mesh(backgroundGeometry, backgroundMaterial);
        background.rotation.x = -Math.PI / 2;
        background.position.y = -0.01;
        scene.add(background);

        // Create a black grid pattern on top of the background
        const gridGeometry = new THREE.PlaneGeometry(10, 10, 10, 10);
        const gridMaterial = new THREE.MeshBasicMaterial({
            color: 0x000000,
            side: THREE.DoubleSide,
            transparent: true,
            opacity: 0.5,
            wireframe: true,
        });
        const grid = new THREE.Mesh(gridGeometry, gridMaterial);
        grid.rotation.x = -Math.PI / 2;
        grid.position.y = 0.001; // Slightly above the grey background
        scene.add(grid);
    }

    // Setup Controls for the Scene
    function setupControls() {
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1, 0);
        controls.update();
        document.addEventListener("keydown", onDocumentKeyDown, false);
    }

    // Animation Loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
        cameraViewportRenderer.render(scene, cameraView);
    }

    // Clamp Rotation Function
    function clampRotation(currentRotation, minAngle, maxAngle) {
        const minRadians = THREE.MathUtils.degToRad(minAngle);
        const maxRadians = THREE.MathUtils.degToRad(maxAngle);
        return Math.max(minRadians, Math.min(maxRadians, currentRotation));
    }

    // Handle Keyboard Inputs
    function onDocumentKeyDown(event) {
        var keyCode = event.which;
        let delta;

        // Base rotation
        if (keyCode == 81 || keyCode == 69) {
            delta = (keyCode == 81 ? -1 : 1) * 0.05;
            base.rotation.y += delta;
        }

        // Shoulder rotation
        if (keyCode == 87 || keyCode == 83) {
            delta = (keyCode == 87 ? 1 : -1) * 0.05;
            shoulder.rotation.x += delta;
            shoulder.rotation.x = clampRotation(shoulder.rotation.x, -45, 45);
        }

        // Elbow rotation (Forearm)
        if (keyCode == 82 || keyCode == 70) {
            delta = (keyCode == 82 ? 1 : -1) * 0.05;
            elbow.rotation.x += delta;
            elbow.rotation.x = clampRotation(elbow.rotation.x, -90, 0);
        }
    }

    // Setup Camera Viewport
    function setupCameraViewport() {
        cameraViewportRenderer = new THREE.WebGLRenderer({alpha: true});
        cameraViewportRenderer.setSize(200, 150);
        cameraViewport.appendChild(cameraViewportRenderer.domElement);

        cameraView = new THREE.PerspectiveCamera(45, 4 / 3, 0.1, 100);
        cameraView.position.set(2, 1, 2);
        cameraView.lookAt(0, 1, 0);
    }

    init();
</script>
</body>
</html>