<!DOCTYPE html>
<html>
<head>
    <title>Simulator</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }

        #keyGuide {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
<!-- Controls Guide -->
<div id="keyGuide">
    <strong>Controls:</strong><br>
    Base - Q/E<br>
    Upper Arm - W/S<br>
    Forearm - R/F<br>
</div>

<!-- Three.js and OrbitControls Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<!-- Main Script for Robot Arm Simulation -->
<script>
    let scene, camera, renderer, controls;
    let base, shoulder, upperArm, elbow, forearm;

    // Initialize Scene, Camera, and Renderer
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(2, 1, 2);
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        addLighting();
        addRobotArmComponents();
        addFloor(); // Adding the floor
        setupControls();

        animate();
    }

    // Add Lighting to the Scene
    function addLighting() {
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0, 1, 1).normalize();
        scene.add(light);
    }

    // Add Robot Arm Components to the Scene
    function addRobotArmComponents() {
        // Base
        base = createSegment(0.5, 0.6, 0.3, 0xff0000, 0.15); // Red
        scene.add(base);

        // Shoulder
        shoulder = createSegment(0.25, 0.25, 0.4, 0x0000ff, 0.4);
        base.add(shoulder);

        // Upper Arm
        upperArm = createSegment(0.15, 0.15, 1.2, 0x0000ff, 0.6); // Blue
        shoulder.add(upperArm);

        // Elbow
        elbow = new THREE.Object3D(); // Creating an empty Object3D for elbow joint
        elbow.position.y = 0.6; // Adjusted position to end of upper arm
        upperArm.add(elbow);

        // Forearm
        forearm = createSegment(0.1, 0.1, 1.0, 0x00ff00, 0.5); // Green
        elbow.add(forearm);
    }

    // Create a Segment of the Robot Arm
    function createSegment(topRadius, bottomRadius, height, color, yPos) {
        const geometry = new THREE.CylinderGeometry(topRadius, bottomRadius, height, 32);
        const material = new THREE.MeshStandardMaterial({color: color});
        const segment = new THREE.Mesh(geometry, material);
        segment.position.y = yPos;
        return segment;
    }

    // Add Floor to the Scene
    function addFloor() {
        const floorGeometry = new THREE.PlaneGeometry(10, 10);
        const floorMaterial = new THREE.MeshStandardMaterial({color: 0x808080, side: THREE.DoubleSide});
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -0.01; // Slightly lower than the base to avoid z-fighting
        scene.add(floor);
    }

    // Setup Controls for the Scene
    function setupControls() {
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1, 0);
        controls.update();

        document.addEventListener("keydown", onDocumentKeyDown, false);
    }

    // Animation Loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    // Clamp Rotation Function
    function clampRotation(currentRotation, minAngle, maxAngle) {
        const minRadians = THREE.MathUtils.degToRad(minAngle);
        const maxRadians = THREE.MathUtils.degToRad(maxAngle);
        return Math.max(minRadians, Math.min(maxRadians, currentRotation));
    }

    // Handle Keyboard Inputs
    function onDocumentKeyDown(event) {
        var keyCode = event.which;
        let delta;

        // Base rotation
        if (keyCode == 81 || keyCode == 69) {
            delta = (keyCode == 81 ? -1 : 1) * 0.05;
            base.rotation.y += delta;
        }

        // Shoulder rotation
        if (keyCode == 87 || keyCode == 83) {
            delta = (keyCode == 87 ? 1 : -1) * 0.05;
            shoulder.rotation.x += delta;
            shoulder.rotation.x = clampRotation(shoulder.rotation.x, -45, 45);
        }

        // Elbow rotation (Forearm)
        if (keyCode == 82 || keyCode == 70) {
            delta = (keyCode == 82 ? 1 : -1) * 0.05;
            elbow.rotation.x += delta;
            elbow.rotation.x = clampRotation(elbow.rotation.x, -90, 0);
        }
    }

    init();
</script>
</body>
</html>