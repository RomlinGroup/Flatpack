<!DOCTYPE html>
<html>

<head>
    <title>Cobot</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://romlin.com/wp-content/uploads/2023/05/flatpack_ai_logo.svg">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div id="robotDirectionDisplay"><span id="directionValue">0</span>Â°</div>

<div id="overviewMap"></div>

<div id="forearmViewWrapper">
    <div id="forearmView"></div>

    <div id="forearmViewObjectDetection">
        <img id="img"/>
        <button id="saveImageButton">Save</button>
    </div>

    <div id="detectionResults"></div>
</div>

<div id="keyGuide">
    Base: Q/E<br>
    Upper Arm: W/S<br>
    Forearm: R/F
</div>

<button id="recordButton">Record</button>
<button id="generateButton">Generate</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/tools/threejs/CannonDebugRenderer.js"></script>

<script>
    const SERVER_URL = "";

    let base;
    let boxBody;
    let camera;
    let controls;
    let elbow;
    let forearm;
    let forearmCamera;
    let forearmCameraIsActive = true;
    let forearmRenderer;
    let fullCycleCount = 0;
    let movementStep = 0;
    let pincerBase;
    let pincerClaw1;
    let pincerClaw2;
    let renderer;
    let resizeTimer;
    let scene;
    let shoulder;
    let upperArm;
    let world;

    function captureImage() {
        updateForearmCamera();
        forearmRenderer.render(scene, forearmCamera);
        var strMime = "image/jpeg";
        return forearmRenderer.domElement.toDataURL(strMime, 1.0);
    }

    async function captureImageBlob() {
        if (forearmRenderer && forearmRenderer.domElement instanceof HTMLCanvasElement) {
            return new Promise(resolve => {

                const offscreenCanvas = document.createElement('canvas');
                const offscreenCtx = offscreenCanvas.getContext('2d');

                const targetWidth = 256;
                const aspectRatio = forearmRenderer.domElement.width / forearmRenderer.domElement.height;
                const targetHeight = targetWidth / aspectRatio;

                offscreenCanvas.width = targetWidth;
                offscreenCanvas.height = targetHeight;

                offscreenCtx.drawImage(forearmRenderer.domElement, 0, 0, forearmRenderer.domElement.width, forearmRenderer.domElement.height, 0, 0, targetWidth, targetHeight);

                const compressionQuality = 0.5;

                forearmRenderer.domElement.toBlob(blob => {
                    resolve(blob);
                }, 'image/jpeg', compressionQuality);
            });
        }
        return null;
    }

    function displayDepthMap(depthMapUrl) {
        const detectionResultsDiv = document.getElementById('detectionResults');
        detectionResultsDiv.innerHTML = '<img src="' + depthMapUrl + '" alt="Depth Map" style="width:100%;height:auto;">';
    }

    function preloadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                resolve(img);
            };
            img.onerror = reject;
            img.src = src;
        });
    }

    async function processAndDisplayDepthMap(poseData) {
        if (!poseData) {
            return;
        }

        try {
            const currentImageBlob = await captureImageBlob();
            if (!currentImageBlob) {
                throw new Error('No image blob captured.');
            }

            const depthMapUrl = await uploadImageAndGetDepthMapUrl(currentImageBlob, poseData);
            displayDepthMap(depthMapUrl);

            //console.log('Depth map processed and displayed.');

        } catch (error) {
            //console.error('Error processing depth map:', error);
        }
    }

    function updateForearmCamera() {
        var pincerBasePosition = new THREE.Vector3();
        pincerBase.getWorldPosition(pincerBasePosition);
        forearmCamera.position.copy(pincerBasePosition);

        var forearmDirection = new THREE.Vector3(0, 0, -1);
        forearm.getWorldDirection(forearmDirection);
        forearmCamera.lookAt(forearmDirection.add(pincerBasePosition));
        forearmCamera.rotateX(THREE.MathUtils.degToRad(0));
    }

    async function updateForearmViewObjectDetection(imageDataUrl) {
        const preloadedImage = await preloadImage(imageDataUrl);

        requestAnimationFrame(() => {
            const img = document.getElementById('img');
            img.src = preloadedImage.src;
        });
    }

    async function uploadImageAndGetDepthMapUrl(imageBlob, poseData) {
        if (!SERVER_URL) {
            console.error("Configuration error: Server URL is not set.");
            throw new Error("Configuration error: Server URL is not set.");
        }

        let formData = new FormData();
        formData.append("file", imageBlob, "image.jpg");
        formData.append("pose_data", JSON.stringify(poseData));

        for (let [key, value] of formData.entries()) {
            //console.log(key, value);
        }

        const url = SERVER_URL + "/process_depth_map/";
        //console.log(`Request URL: ${url}`);

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            //console.log(`Response status: ${response.status}`);

            if (!response.ok) {
                //console.error(`Server response error: status ${response.status}`);
                const responseText = await response.text();
                //console.error(`Response text: ${responseText}`);
                throw new Error(`Server response error: status ${response.status}`);
            }

            const depthMapBlob = await response.blob();
            return URL.createObjectURL(depthMapBlob);
        } catch (error) {
            //console.error('Error in uploading image:', error);
            //console.error(`Error details: ${error.message}`);
            throw error;
        }
    }

    const demoSpeed = 0.1;
</script>

<script src="RobotController.js"></script>
<script type="module" src="script.js"></script>
</body>

</html>